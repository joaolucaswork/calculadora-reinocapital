<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Salesforce Authentication</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        background-color: #f4f4f4;
      }
      .container {
        text-align: center;
        background: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #0176d3;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .error {
        color: #d73527;
        margin-top: 1rem;
      }
      .success {
        color: #4bca81;
        margin-top: 1rem;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="spinner"></div>
      <h2>Authenticating with Salesforce...</h2>
      <p id="status">Please wait while we complete the authentication process.</p>
    </div>

    <script>
      (function () {
        'use strict';

        const statusElement = document.getElementById('status');

        function updateStatus(message, type = 'info') {
          statusElement.textContent = message;
          statusElement.className = type;
        }

        function getUrlParameter(name) {
          const urlParams = new URLSearchParams(window.location.search);
          return urlParams.get(name);
        }

        async function handleAuthCallback() {
          try {
            const code = getUrlParameter('code');
            const error = getUrlParameter('error');
            const state = getUrlParameter('state');

            if (error) {
              throw new Error(`Authentication failed: ${error}`);
            }

            if (!code) {
              throw new Error('No authorization code received');
            }

            updateStatus('Exchanging authorization code for access token...');

            // Exchange authorization code for access token
            const tokenResponse = await exchangeCodeForToken(code);

            if (tokenResponse.access_token) {
              updateStatus('Authentication successful! Closing window...', 'success');

              // Send success message to parent window
              if (window.opener) {
                window.opener.postMessage(
                  {
                    type: 'salesforce_auth_success',
                    access_token: tokenResponse.access_token,
                    instance_url: tokenResponse.instance_url,
                    refresh_token: tokenResponse.refresh_token,
                  },
                  window.location.origin
                );
              }

              // Close the popup after a short delay
              setTimeout(() => {
                window.close();
              }, 1500);
            } else {
              throw new Error('No access token received');
            }
          } catch (error) {
            console.error('Authentication error:', error);
            updateStatus(`Error: ${error.message}`, 'error');

            // Send error message to parent window
            if (window.opener) {
              window.opener.postMessage(
                {
                  type: 'salesforce_auth_error',
                  error: error.message,
                },
                window.location.origin
              );
            }

            // Close the popup after showing error
            setTimeout(() => {
              window.close();
            }, 3000);
          }
        }

        async function exchangeCodeForToken(code) {
          // Note: In a production environment, this token exchange should be done
          // on the server side to keep the client secret secure.
          // For this implementation, we'll use the implicit flow or
          // a server-side endpoint to handle the token exchange.

          // This is a simplified version - in practice, you would:
          // 1. Send the code to your server
          // 2. Server exchanges code for token using client secret
          // 3. Server returns the token to the client

          const response = await fetch('/api/salesforce/token', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              code: code,
              redirect_uri: window.location.origin + '/oauth-callback.html',
            }),
          });

          if (!response.ok) {
            throw new Error(`Token exchange failed: ${response.statusText}`);
          }

          return await response.json();
        }

        // Start the authentication process when the page loads
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', handleAuthCallback);
        } else {
          handleAuthCallback();
        }
      })();
    </script>
  </body>
</html>
